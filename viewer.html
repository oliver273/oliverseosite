<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer - OliverSEO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onerror="console.error('Failed to load marked.js'); document.getElementById('content').innerHTML = '<div class=\'error\'><h2>Error: Cannot load Marked.js library</h2><p>Please check your internet connection and refresh the page.</p><a href=\'dashboard-fixed.html\' class=\'back-btn\'>‚Üê Back to Dashboard</a></div>';"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #f59e0b;
            --secondary: #d97706;
            --accent: #fbbf24;
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #334155;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        .header {
            background: var(--surface);
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 1rem;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .back-btn {
            background: var(--primary);
            color: var(--background);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            display: inline-block;
        }
        
        .back-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .markdown-body {
            background: var(--surface);
            border: 1px solid rgba(51, 65, 85, 0.5);
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: var(--text);
            transition: all 0.4s;
        }
        
        .markdown-body:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .markdown-body h1 {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .markdown-body h2 {
            color: var(--primary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .markdown-body h3 {
            color: var(--text);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .markdown-body h4 {
            color: var(--text-secondary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .markdown-body p {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        
        .markdown-body li {
            margin-bottom: 0.75rem;
            color: var(--text);
            line-height: 1.8;
        }
        
        .markdown-body ul li::marker {
            color: var(--primary);
        }
        
        .markdown-body ol li::marker {
            color: var(--primary);
            font-weight: bold;
        }
        
        .markdown-body code {
            background: rgba(15, 23, 42, 0.8);
            color: var(--accent);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        .markdown-body pre {
            background: rgba(15, 23, 42, 0.8);
            padding: 1.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .markdown-body pre code {
            background: transparent;
            color: var(--text);
            padding: 0;
            border: none;
        }
        
        .markdown-body blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 0.5rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .markdown-body table th,
        .markdown-body table td {
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            text-align: left;
        }
        
        .markdown-body table th {
            background: rgba(245, 158, 11, 0.2);
            color: var(--primary);
            font-weight: bold;
        }
        
        .markdown-body table tr:nth-child(even) {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .markdown-body table tr:hover {
            background: rgba(51, 65, 85, 0.5);
        }
        
        .markdown-body a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .markdown-body a:hover {
            color: var(--accent);
            text-decoration: underline;
        }
        
        .markdown-body strong {
            color: var(--text);
            font-weight: bold;
        }
        
        .markdown-body em {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .markdown-body hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .markdown-body img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 2rem 0;
        }
        
        .toc {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }
        
        .toc h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-weight: bold;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        
        .toc li {
            margin-bottom: 0.5rem;
        }
        
        .toc a {
            color: var(--text);
            text-decoration: none;
            transition: color 0.3s;
            font-weight: 500;
        }
        
        .toc a:hover {
            color: var(--primary);
        }
        
        /* Checkbox styling for checklists */
        .markdown-body input[type="checkbox"] {
            width: 1.5rem !important;
            height: 1.5rem !important;
            min-width: 1.5rem !important;
            min-height: 1.5rem !important;
            margin-right: 0.75rem !important;
            margin-left: 0 !important;
            margin-top: 0.125rem !important;
            accent-color: var(--primary) !important;
            cursor: pointer !important;
            flex-shrink: 0;
            pointer-events: auto !important;
            opacity: 1 !important;
            position: relative;
            z-index: 10;
            -webkit-appearance: checkbox !important;
            appearance: checkbox !important;
        }
        
        .markdown-body input[type="checkbox"]:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        
        .markdown-body input[type="checkbox"]:active {
            transform: scale(0.95);
        }
        
        .markdown-body li {
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .markdown-body li input[type="checkbox"]:hover {
            transform: scale(1.1);
        }
        
        .markdown-body li.checked {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .markdown-body li.checked strong {
            opacity: 0.7;
        }
        
        /* Emoji and special characters */
        .markdown-body {
            font-size: 1.125rem;
        }
        
        /* Strong emphasis */
        .markdown-body strong {
            color: var(--text);
            font-weight: 700;
        }
        
        /* Horizontal rule */
        .markdown-body hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2.5rem 0;
            opacity: 0.5;
        }
        
        /* Badge/Highlight styling */
        .markdown-body :is(h1, h2, h3, h4, h5, h6) {
            scroll-margin-top: 100px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .markdown-body {
                padding: 1.5rem;
                font-size: 1rem;
            }
            
            .markdown-body h1 {
                font-size: 2rem;
            }
            
            .markdown-body h2 {
                font-size: 1.75rem;
            }
            
            .markdown-body h3 {
                font-size: 1.5rem;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Document Viewer</h1>
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <span id="checkbox-status" style="color: var(--text-secondary); font-size: 0.875rem;"></span>
            <a href="dashboard-fixed.html" class="back-btn">‚Üê Back to Dashboard</a>
            <a href="javascript:window.print()" class="back-btn" style="margin-left: 0.5rem;">üñ®Ô∏è Print</a>
        </div>
    </div>
    
    <div class="container">
        <div id="content" class="loading">
            Loading document...
        </div>
    </div>
    
    <script>
        // Initialize viewer
        (function() {
            console.log('=== VIEWER SCRIPT STARTING ===');
            
            // Get filename from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            let file = urlParams.get('file');
            
            // If no file specified, redirect to dashboard
            if (!file) {
                console.log('No file specified, redirecting to dashboard...');
                window.location.href = 'dashboard-fixed.html';
                return;
            }
            
            console.log('Starting viewer for file:', file);
            console.log('Current URL:', window.location.href);
            console.log('Marked.js available:', typeof marked !== 'undefined');
            
            // Wait for marked.js to load (it might be loading asynchronously)
            function waitForMarked(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkMarked = () => {
                attempts++;
                console.log(`Checking for marked.js (attempt ${attempts}/${maxAttempts})...`);
                
                if (typeof marked !== 'undefined') {
                    console.log('‚úÖ Marked.js is loaded!');
                    callback();
                } else if (attempts >= maxAttempts) {
                    console.error('‚ùå Marked.js failed to load after ' + maxAttempts + ' attempts');
                    // Try to load marked.js manually
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                    script.onload = function() {
                        console.log('Marked.js loaded successfully (manual load)');
                        callback();
                    };
                    script.onerror = function() {
                        console.error('Failed to load marked.js');
                        document.getElementById('content').innerHTML = `
                            <div class="error">
                                <h2>Error: Cannot load Marked.js library</h2>
                                <p>Please check your internet connection and refresh the page.</p>
                                <p>File: ${file}</p>
                                <a href="dashboard-fixed.html" class="back-btn" style="display: inline-block; margin-top: 1rem;">‚Üê Back to Dashboard</a>
                            </div>
                        `;
                    };
                    document.head.appendChild(script);
                } else {
                    setTimeout(checkMarked, 100);
                }
            };
            checkMarked();
        }
        
            // Wait for marked.js, then initialize
            waitForMarked(() => {
                initializeViewer(file);
            });
        })(); // End of IIFE
        
        function initializeViewer(file) {
            console.log('Initializing viewer for file:', file);
            
            if (!file) {
                console.error('No file specified!');
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h2>Error: No file specified</h2>
                        <p>Please open a file from the dashboard.</p>
                        <a href="dashboard-fixed.html" class="back-btn" style="display: inline-block; margin-top: 1rem;">‚Üê Back to Dashboard</a>
                    </div>
                `;
                return;
            }
            
            // Show loading state with timeout
            const loadingTimeout = setTimeout(() => {
                if (document.getElementById('content').innerHTML.includes('Loading document')) {
                    console.error('Loading timeout - showing error');
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <h2>‚è±Ô∏è Loading Timeout</h2>
                            <p>The file is taking too long to load.</p>
                            <p><strong>File:</strong> ${file}</p>
                            <p style="margin-top: 1rem; color: var(--text-secondary);">
                                This might be a CORS issue or the file might not exist. 
                                If you're using a browser (not Electron), you may need to run a local server.
                            </p>
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                                <a href="dashboard-fixed.html" class="back-btn" style="display: inline-block;">‚Üê Back to Dashboard</a>
                                <button onclick="window.location.reload()" class="back-btn" style="background: var(--surface); border: 1px solid var(--border);">üîÑ Retry</button>
                            </div>
                        </div>
                    `;
                }
            }, 15000); // 15 second timeout
            
            document.getElementById('content').innerHTML = '<div class="loading">Loading document...<br><small style="color: var(--text-secondary);">File: ' + file + '</small><br><small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Checking server connection...</small><div id="debug-info" style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary);"></div></div>';
            
            // Get debug element once
            const debugEl = document.getElementById('debug-info');
            if (debugEl) {
                debugEl.innerHTML = 'Protocol: ' + window.location.protocol + '<br>Marked.js: ' + (typeof marked !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded');
            }
        
            // Add timeout to fetch
            const fetchWithTimeout = (url, timeout = 10000) => {
                console.log('Fetching URL:', url);
                console.log('Current page URL:', window.location.href);
                console.log('Protocol:', window.location.protocol);
                
                return Promise.race([
                    fetch(url).catch(err => {
                        console.error('Fetch error:', err);
                        throw new Error(`Failed to fetch file: ${err.message}. Make sure you're accessing via http://localhost:8000, not file://`);
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout - file may not exist or there may be a CORS issue. Make sure you\'re accessing via http://localhost:8000')), timeout)
                    )
                ]);
            };
            
            // Check if we're using file:// protocol (which won't work)
            if (window.location.protocol === 'file:') {
                const serverUrl = `http://localhost:8000/viewer.html?file=${encodeURIComponent(file)}`;
                console.warn('Detected file:// protocol - redirecting to server');
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h2>‚ö†Ô∏è Please Use Local Server</h2>
                        <p>You're accessing via <code>file://</code> which won't work.</p>
                        <p>Please access the dashboard through the local server:</p>
                        <p style="margin: 1rem 0;">
                            <a href="http://localhost:8000/dashboard-fixed.html" style="color: var(--primary); font-weight: bold; font-size: 1.1rem;">
                                http://localhost:8000/dashboard-fixed.html
                            </a>
                        </p>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">
                            Or click this link to open the viewer via server:
                        </p>
                        <a href="${serverUrl}" class="back-btn" style="display: inline-block; margin-top: 1rem;">
                            Open via Server ‚Üí
                        </a>
                    </div>
                `;
                return;
            }
            
            // Load and render markdown
            console.log('Starting fetch for:', file);
            // debugEl already declared above
            if (debugEl) {
                debugEl.innerHTML += '<br>Fetching: ' + file;
            }
            
            fetchWithTimeout(file, 10000)
            .then(response => {
                console.log('‚úÖ Fetch response received:', response.status, response.statusText);
                if (debugEl) {
                    debugEl.innerHTML += '<br>Response: ' + response.status + ' ' + response.statusText;
                }
                if (!response.ok) {
                    throw new Error(`File not found (HTTP ${response.status})`);
                }
                return response.text();
            })
            .then(markdown => {
                clearTimeout(loadingTimeout); // Clear the loading timeout
                console.log('‚úÖ Markdown loaded successfully!');
                console.log('Markdown length:', markdown.length);
                console.log('Sample markdown:', markdown.substring(0, 200));
                
                // Check if marked is available
                if (typeof marked === 'undefined') {
                    throw new Error('Marked.js library is not loaded. Please refresh the page.');
                }
                console.log('‚úÖ Marked.js is available');
                
                // Extract title from markdown (do this early so it's available everywhere)
                const titleMatch = markdown.match(/^#\s+(.+)$/m);
                
                // Check if markdown has checkboxes
                const hasCheckboxes = /- \[[ xX]\]/.test(markdown);
                console.log('Markdown contains checkboxes:', hasCheckboxes);
                
                if (hasCheckboxes) {
                    const checkboxMatches = markdown.match(/- \[[ xX]\]/g);
                    console.log('Found checkbox patterns:', checkboxMatches ? checkboxMatches.length : 0);
                    if (checkboxMatches) {
                        console.log('Sample patterns:', checkboxMatches.slice(0, 3));
                    }
                }
                
                // Configure marked options
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,  // GitHub Flavored Markdown - enables checkboxes
                        headerIds: true,
                        mangle: false,
                        pedantic: false,
                        sanitize: false,  // Don't sanitize - we need checkboxes
                        smartLists: true,
                        smartypants: false
                    });
                    
                    // Convert markdown to HTML
                    // Marked.js with GFM should convert - [ ] to <input type="checkbox" disabled>
                    let html = marked.parse(markdown);
                    console.log('HTML generated by marked.js, length:', html.length);
                    
                    // Check what marked.js actually produced
                    const hasDisabledCheckboxes = /<input[^>]*type=["']checkbox["'][^>]*disabled/gi.test(html);
                    console.log('HTML contains disabled checkboxes:', hasDisabledCheckboxes);
                    console.log('HTML generated, length:', html.length);
                    console.log('HTML contains checkbox:', /<input[^>]*type=["']checkbox["']/i.test(html));
                    
                    // Ensure checkboxes are rendered
                    // Marked.js with GFM should convert - [ ] to checkboxes, but let's ensure it
                    const beforeReplace = html;
                    console.log('HTML before checkbox processing (first 500 chars):', html.substring(0, 500));
                    
                    // CRITICAL: Remove disabled attribute from checkboxes created by marked.js
                    // Marked.js creates <input disabled="" type="checkbox"> or <input type="checkbox" disabled>
                    // We need to remove "disabled" in any position
                    console.log('Removing disabled attributes from checkboxes...');
                    const beforeDisabledRemoval = html;
                    
                    // Find all input tags with type="checkbox" and remove disabled attribute
                    html = html.replace(/<input\s+([^>]*?)>/gi, function(match, attrs) {
                        // Only process checkbox inputs
                        if (!/type\s*=\s*["']checkbox["']/i.test(attrs)) {
                            return match; // Not a checkbox, return as-is
                        }
                        
                        // Remove disabled attribute in any form: disabled, disabled="", disabled="disabled", etc.
                        const cleanedAttrs = attrs
                            .replace(/\s+disabled(="[^"]*")?/gi, '')  // Remove disabled="..."
                            .replace(/\s+disabled\b/gi, '')  // Remove standalone disabled
                            .replace(/\s+/g, ' ')  // Normalize spaces
                            .trim();
                        
                        return `<input ${cleanedAttrs}>`;
                    });
                    
                    if (html !== beforeDisabledRemoval) {
                        console.log('Disabled attributes removed successfully');
                        // Verify removal worked
                        const stillDisabled = /<input[^>]*disabled[^>]*type=["']checkbox["']/gi.test(html);
                        console.log('Checkboxes still have disabled:', stillDisabled);
                    } else {
                        console.warn('No disabled attributes found to remove');
                    }
                    
                    // Pattern 2: Marked.js converted to <li><p>[ ]</p> (sometimes happens)
                    html = html.replace(/<li>\s*<p>\[ \]<\/p>/gi, '<li><input type="checkbox">');
                    html = html.replace(/<li>\s*<p>\[x\]<\/p>/gi, '<li><input type="checkbox" checked>');
                    html = html.replace(/<li>\s*<p>\[X\]<\/p>/gi, '<li><input type="checkbox" checked>');
                    
                    // Pattern 3: Plain text [ ] in list items
                    html = html.replace(/<li>\[ \]/g, '<li><input type="checkbox">');
                    html = html.replace(/<li>\[x\]/gi, '<li><input type="checkbox" checked>');
                    html = html.replace(/<li>\[X\]/g, '<li><input type="checkbox" checked>');
                    
                    // Pattern 4: [ ] with text after (no paragraph)
                    html = html.replace(/<li>\[ \]([^<]+)/g, '<li><input type="checkbox">$1');
                    html = html.replace(/<li>\[x\]([^<]+)/gi, '<li><input type="checkbox" checked>$1');
                    html = html.replace(/<li>\[X\]([^<]+)/g, '<li><input type="checkbox" checked>$1');
                    
                    // Pattern 5: [ ] inside paragraph tags
                    html = html.replace(/<p>\[ \]<\/p>/g, '<input type="checkbox">');
                    html = html.replace(/<p>\[x\]<\/p>/gi, '<input type="checkbox" checked>');
                    html = html.replace(/<p>\[X\]<\/p>/g, '<input type="checkbox" checked>');
                    
                    // Pattern 6: [ ] with text in paragraph
                    html = html.replace(/<p>\[ \]([^<]+)<\/p>/g, '<input type="checkbox">$1');
                    html = html.replace(/<p>\[x\]([^<]+)<\/p>/gi, '<input type="checkbox" checked>$1');
                    html = html.replace(/<p>\[X\]([^<]+)<\/p>/g, '<input type="checkbox" checked>$1');
                    
                    if (html !== beforeReplace) {
                        console.log('Checkboxes replaced via regex');
                    }
                    
                    // Count checkboxes in HTML
                    const checkboxCount = (html.match(/<input[^>]*type=["']checkbox["']/gi) || []).length;
                    console.log('Checkboxes in HTML after processing:', checkboxCount);
                    
                    // Log sample of HTML to see what we're working with
                    if (checkboxCount > 0) {
                        const sampleMatch = html.match(/<li>.*?<input[^>]*type=["']checkbox["'][^>]*>.*?<\/li>/i);
                        if (sampleMatch) {
                            console.log('Sample checkbox HTML:', sampleMatch[0].substring(0, 200));
                        }
                    } else {
                        console.warn('WARNING: No checkboxes found in HTML!');
                        console.log('HTML sample (first 1000 chars):', html.substring(0, 1000));
                        
                        // Try to find what marked.js actually created
                        const listItems = html.match(/<li>.*?<\/li>/gi);
                        if (listItems) {
                            console.log('Found list items:', listItems.length);
                            console.log('Sample list items:', listItems.slice(0, 3));
                        }
                    }
                    
                    if (html !== beforeReplace) {
                        console.log('Checkboxes replaced via regex');
                    }
                    
                    // Update page title (titleMatch defined above)
                    if (titleMatch) {
                        document.title = titleMatch[1] + ' - OliverSEO';
                    }
                    
                    // Special handling for DAILY_SALE_TRACKER.md
                    let noticeHtml = '';
                    if (file === 'DAILY_SALE_TRACKER.md') {
                        noticeHtml = `
                            <div style="background: linear-gradient(135deg, #f59e0b20 0%, #f59e0b10 100%); border: 2px solid #f59e0b; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                                <h2 style="color: #f59e0b; margin-bottom: 1rem; font-size: 1.5rem;">üìä Fillable Tracker</h2>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 1rem;">
                                    ‚úì All "___" fields are now editable! Click any field to fill it in. Your data saves automatically.
                                </p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem;">
                                    <a href="daily_sale_tracker.html" target="_blank" style="display: inline-block; background: #f59e0b; color: #0f172a; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; font-size: 0.875rem;">
                                        üöÄ Full Interactive Version ‚Üí
                                    </a>
                                    <button onclick="clearFillableInputs('${file}')" style="background: var(--surface-light); color: var(--text); padding: 0.75rem 1.5rem; border: 1px solid var(--border); border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; cursor: pointer;">
                                        üóëÔ∏è Clear All Fields
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Convert "___" placeholders to editable input fields (for DAILY_SALE_TRACKER.md)
                    if (file === 'DAILY_SALE_TRACKER.md') {
                        // Replace ___ with input fields
                        html = html.replace(/___+/g, function(match) {
                            const id = 'input_' + Math.random().toString(36).substr(2, 9);
                            return `<input type="text" class="fillable-input" data-id="${id}" placeholder="Enter value" style="display: inline-block; min-width: 80px; padding: 0.25rem 0.5rem; background: var(--surface-light); border: 1px solid var(--primary); border-radius: 0.25rem; color: var(--text); font-size: 0.875rem; margin: 0 0.25rem;" />`;
                        });
                        
                        // Replace table cells with ___ to have input fields
                        html = html.replace(/<td>___<\/td>/gi, function(match) {
                            const id = 'input_' + Math.random().toString(36).substr(2, 9);
                            return `<td><input type="text" class="fillable-input table-input" data-id="${id}" placeholder="0" style="width: 100%; padding: 0.5rem; background: var(--surface-light); border: 1px solid var(--primary); border-radius: 0.25rem; color: var(--text); font-size: 0.875rem;" /></td>`;
                        });
                        
                        // Replace bold ___ in totals row
                        html = html.replace(/<strong>___+<\/strong>/gi, function(match) {
                            const id = 'input_' + Math.random().toString(36).substr(2, 9);
                            return `<strong><input type="text" class="fillable-input" data-id="${id}" placeholder="0" style="display: inline-block; min-width: 60px; padding: 0.25rem 0.5rem; background: var(--surface-light); border: 1px solid var(--primary); border-radius: 0.25rem; color: var(--text); font-size: 0.875rem; font-weight: bold;" /></strong>`;
                        });
                    }
                    
                    // Render content
                    document.getElementById('content').innerHTML = `
                        ${noticeHtml}
                        <div class="markdown-body">
                            ${html}
                        </div>
                    `;
                    
                    console.log('Content rendered to DOM');
                    
                    // Load saved values for fillable inputs
                    if (file === 'DAILY_SALE_TRACKER.md') {
                        loadFillableInputs(file);
                        attachFillableInputListeners(file);
                    }
                    
                    // Check for checkboxes in DOM and remove disabled attribute directly
                    setTimeout(() => {
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        console.log('Checkboxes found in DOM:', checkboxes.length);
                        
                        // CRITICAL: Remove disabled attribute directly from DOM elements
                        let removedCount = 0;
                        checkboxes.forEach(cb => {
                            if (cb.hasAttribute('disabled')) {
                                cb.removeAttribute('disabled');
                                removedCount++;
                            }
                        });
                        
                        if (removedCount > 0) {
                            console.log(`Removed disabled attribute from ${removedCount} checkboxes in DOM`);
                        }
                        
                        if (checkboxes.length > 0) {
                            console.log('First checkbox after cleanup:', checkboxes[0]);
                            console.log('First checkbox disabled?', checkboxes[0].hasAttribute('disabled'));
                        }
                    }, 100);
                    
                    // Make checkboxes interactive - use multiple attempts to ensure it works
                    const initCheckboxes = () => {
                        console.log('Initializing checkboxes...');
                        makeCheckboxesInteractive(file);
                    };
                    
                    // Try immediately and with delays
                    initCheckboxes();
                    setTimeout(initCheckboxes, 100);
                    setTimeout(initCheckboxes, 300);
                    setTimeout(initCheckboxes, 500);
                    setTimeout(initCheckboxes, 1000);
                } else {
                    console.error('Marked.js not loaded!');
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <h2>Error: Marked.js library not loaded</h2>
                            <p>Please check your internet connection and refresh the page.</p>
                        </div>
                    `;
                }
                
                // Update header with document title (titleMatch defined above)
                if (titleMatch) {
                    const headerTitle = document.querySelector('.header h1');
                    if (headerTitle) {
                        headerTitle.textContent = titleMatch[1];
                    }
                }
            })
            .catch(error => {
                clearTimeout(loadingTimeout); // Clear the loading timeout
                console.error('Error loading file:', error);
                console.error('Error details:', error);
                console.error('File that failed:', file);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Document</h2>
                        <p><strong>Error:</strong> ${error.message || 'Unknown error'}</p>
                        <p><strong>File:</strong> ${file}</p>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">
                            <strong>Possible causes:</strong><br>
                            ‚Ä¢ File doesn't exist at this path<br>
                            ‚Ä¢ CORS restrictions (if running from file://)<br>
                            ‚Ä¢ Network timeout<br>
                            ‚Ä¢ File path is incorrect
                        </p>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">
                            <strong>Solution:</strong> Make sure you're opening files from the dashboard cards, not directly.
                        </p>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="dashboard-fixed.html" class="back-btn" style="display: inline-block;">‚Üê Back to Dashboard</a>
                            <button onclick="window.location.reload()" class="back-btn" style="background: var(--surface); border: 1px solid var(--border);">üîÑ Retry</button>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 0.5rem; border: 1px solid var(--primary);">
                            <strong style="color: var(--primary);">üí° Quick Fix:</strong>
                            <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                If you're using the Electron app, make sure you're clicking cards from the dashboard. 
                                If you're using a browser, you may need to run a local server.
                            </p>
                        </div>
                    </div>
                `;
            });
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error, e.message, e.filename, e.lineno);
        });
        
        // Functions for fillable inputs (DAILY_SALE_TRACKER.md)
        function loadFillableInputs(file) {
            const storageKey = `fillable_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.keys(data).forEach(id => {
                        const input = document.querySelector(`.fillable-input[data-id="${id}"]`);
                        if (input) {
                            input.value = data[id];
                        }
                    });
                } catch (e) {
                    console.error('Error loading fillable inputs:', e);
                }
            }
        }
        
        function saveFillableInput(file, inputId, value) {
            const storageKey = `fillable_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const saved = localStorage.getItem(storageKey);
            let data = saved ? JSON.parse(saved) : {};
            data[inputId] = value;
            localStorage.setItem(storageKey, JSON.stringify(data));
        }
        
        function attachFillableInputListeners(file) {
            const inputs = document.querySelectorAll('.fillable-input');
            inputs.forEach(input => {
                // Load existing value
                const inputId = input.dataset.id;
                const storageKey = `fillable_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (data[inputId]) {
                            input.value = data[inputId];
                        }
                    } catch (e) {
                        // Ignore
                    }
                }
                
                // Save on change
                input.addEventListener('input', function() {
                    saveFillableInput(file, inputId, this.value);
                });
                
                input.addEventListener('blur', function() {
                    saveFillableInput(file, inputId, this.value);
                });
            });
        }
        
        // Clear fillable inputs function
        function clearFillableInputs(file) {
            if (confirm('Clear all filled-in values? This cannot be undone.')) {
                const storageKey = `fillable_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
                localStorage.removeItem(storageKey);
                const inputs = document.querySelectorAll('.fillable-input');
                inputs.forEach(input => {
                    input.value = '';
                });
                alert('All fields cleared!');
            }
        }
        
        // Make clearFillableInputs available globally
        window.clearFillableInputs = clearFillableInputs;
        
        console.log('=== VIEWER SCRIPT LOADED ===');
        
        // Make checkboxes interactive using event delegation (more reliable)
        let eventListenersAttached = false;
        
        function makeCheckboxesInteractive(file) {
            console.log('makeCheckboxesInteractive called for:', file);
            
            const storageKey = `checklist_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const markdownBody = document.querySelector('.markdown-body');
            
            if (!markdownBody) {
                console.warn('Markdown body not found, retrying...');
                return;
            }
            
            // Find checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            console.log('Found checkboxes:', checkboxes.length);
            
            if (checkboxes.length === 0) {
                console.warn('No checkboxes found in document');
                const statusEl = document.getElementById('checkbox-status');
                if (statusEl) {
                    statusEl.textContent = 'No checkboxes in this document';
                    statusEl.style.color = 'var(--text-secondary)';
                }
                return;
            }
            
            // Attach event listeners only once
            if (!eventListenersAttached) {
                console.log('Attaching event listeners...');
                
                // Use event delegation - attach listener to parent
                markdownBody.addEventListener('change', function(e) {
                    console.log('Change event detected:', e.target.type);
                    if (e.target.type === 'checkbox') {
                        console.log('Checkbox change event!');
                        handleCheckboxChange(e.target, file, storageKey);
                    }
                });
                
                // Also handle click events
                markdownBody.addEventListener('click', function(e) {
                    if (e.target.type === 'checkbox') {
                        console.log('Checkbox clicked!');
                        // Let the default behavior happen, then update
                        setTimeout(() => {
                            handleCheckboxChange(e.target, file, storageKey);
                        }, 10);
                    }
                });
                
                eventListenersAttached = true;
                console.log('Event listeners attached');
            }
            
            // Load and apply saved state
            loadCheckboxState(file, storageKey);
            
            // Update progress
            setTimeout(() => updateChecklistProgress(file), 100);
            
            // Update status indicator
            const statusEl = document.getElementById('checkbox-status');
            if (statusEl) {
                if (checkboxes.length > 0) {
                    statusEl.textContent = `‚úì ${checkboxes.length} checkboxes ready`;
                    statusEl.style.color = 'var(--success)';
                } else {
                    statusEl.textContent = 'No checkboxes found';
                    statusEl.style.color = 'var(--text-secondary)';
                }
            }
        }
        
        // Handle checkbox change
        function handleCheckboxChange(checkbox, file, storageKey) {
            console.log('Checkbox changed!', checkbox.checked);
            
            const listItem = checkbox.closest('li');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const index = Array.from(checkboxes).indexOf(checkbox);
            const key = `${file}_${index}`;
            
            // Load current state
            let savedState = {};
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    savedState = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            
            // Save state
            if (checkbox.checked) {
                savedState[key] = true;
            } else {
                delete savedState[key];
            }
            
            try {
                localStorage.setItem(storageKey, JSON.stringify(savedState));
                console.log('State saved successfully');
            } catch (e) {
                console.error('Error saving state:', e);
            }
            
            // Update visual state
            if (listItem) {
                if (checkbox.checked) {
                    listItem.style.opacity = '0.6';
                    listItem.style.textDecoration = 'line-through';
                    listItem.classList.add('checked');
                } else {
                    listItem.style.opacity = '1';
                    listItem.style.textDecoration = 'none';
                    listItem.classList.remove('checked');
                }
            }
            
            // Update progress
            updateChecklistProgress(file);
        }
        
        // Load saved checkbox state
        function loadCheckboxState(file, storageKey) {
            let savedState = {};
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    savedState = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading saved state:', e);
                return;
            }
            
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                const key = `${file}_${index}`;
                if (savedState[key]) {
                    checkbox.checked = true;
                    const listItem = checkbox.closest('li');
                    if (listItem) {
                        listItem.style.opacity = '0.6';
                        listItem.style.textDecoration = 'line-through';
                        listItem.classList.add('checked');
                    }
                }
            });
        }
        
        // Update checklist progress indicator
        function updateChecklistProgress(file) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checked = document.querySelectorAll('input[type="checkbox"]:checked');
            const total = checkboxes.length;
            const completed = checked.length;
            
            if (total > 0) {
                const percentage = Math.round((completed / total) * 100);
                
                // Find or create progress indicator
                let progressBar = document.querySelector('.checklist-progress');
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.className = 'checklist-progress';
                    progressBar.style.cssText = `
                        background: rgba(30, 41, 59, 0.9);
                        backdrop-filter: blur(10px);
                        border: 1px solid #334155;
                        padding: 1.25rem;
                        border-radius: 0.75rem;
                        margin-bottom: 2rem;
                        position: sticky;
                        top: 120px;
                        z-index: 10;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    `;
                    const markdownBody = document.querySelector('.markdown-body');
                    if (markdownBody) {
                        markdownBody.insertBefore(progressBar, markdownBody.firstChild);
                    }
                }
                
                // Determine color based on progress
                let progressColor = 'var(--primary)';
                if (percentage === 100) {
                    progressColor = '#10b981'; // Green when complete
                } else if (percentage >= 75) {
                    progressColor = '#f59e0b'; // Orange
                } else if (percentage >= 50) {
                    progressColor = '#fbbf24'; // Light orange
                }
                
                progressBar.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                        <strong style="color: var(--primary); font-size: 1.125rem;">üìã Checklist Progress</strong>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="color: var(--text-secondary); font-weight: 600;">${completed} / ${total} (${percentage}%)</span>
                            ${completed > 0 ? `<button onclick="clearChecklist('${file}')" style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--text-secondary)'">Clear All</button>` : ''}
                        </div>
                    </div>
                    <div style="background: var(--background); height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #334155;">
                        <div style="background: ${progressColor}; height: 100%; width: ${percentage}%; transition: width 0.5s ease; border-radius: 5px;"></div>
                    </div>
                    ${percentage === 100 ? '<div style="margin-top: 0.75rem; color: #10b981; font-weight: 600; text-align: center;">üéâ All items completed!</div>' : ''}
                `;
            }
        }
        
        // Clear all checkboxes function
        function clearChecklist(file) {
            if (confirm('Are you sure you want to clear all checked items?')) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const storageKey = `checklist_${file.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const listItem = checkbox.closest('li');
                    if (listItem) {
                        listItem.style.opacity = '1';
                        listItem.style.textDecoration = 'none';
                    }
                });
                
                // Clear saved state
                localStorage.removeItem(storageKey);
                
                // Update progress
                updateChecklistProgress(file);
            }
        }
        
        // Make clearChecklist available globally
        window.clearChecklist = clearChecklist;
        
        // Add additional CSS for better checklist styling
        const additionalStyle = document.createElement('style');
        additionalStyle.textContent = `
            .markdown-body li:has(input[type="checkbox"]) {
                padding: 0.5rem;
                margin: 0.25rem 0;
                border-radius: 0.25rem;
                transition: all 0.3s ease;
            }
            
            .markdown-body li:has(input[type="checkbox"]:hover) {
                background: rgba(51, 65, 85, 0.2);
            }
            
            .markdown-body li:has(input[type="checkbox"]:checked) {
                background: rgba(245, 158, 11, 0.1);
            }
            
            .markdown-body input[type="checkbox"]:focus {
                outline: 2px solid var(--primary);
                outline-offset: 2px;
            }
        `;
        document.head.appendChild(additionalStyle);
    </script>
</body>
</html>

